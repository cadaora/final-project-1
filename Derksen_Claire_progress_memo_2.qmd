---
title: "Progress Memo 2"
subtitle: |
  | Final Project 
  | Data Science 1 with R (STAT 301-1)
author: "Claire Derksen"
date: today

format:
  html:
    toc: true
    embed-resources: true
    
execute:
  echo: false
  warning: false

from: markdown+emoji 
---
```{r}
#| label: load-pkgs
# Loading package(s)
library(tidyverse)
library(naniar)
library(janitor)
library(readxl)
library(knitr)
library(ggthemes)
```
## Github Repo Link

<https://github.com/stat301-1-2023-fall/final-project-1-cadaora>

```{r}
#| label: create-YA-rds-files
#| eval: false

# list of comparable variables
comparability <- read_excel("data/RDAS_Comparability.xlsx") %>%
  filter(!is.na(`2019-2020`)) %>%
  select(Variable) %>%
  deframe()

NSDUH_2021 <-read.delim(file="data/NSDUH_2021_Tab.txt",na.strings = ".")
NSDUH_2020 <-read.delim(file="data/NSDUH_2020_Tab.txt",na.strings = ".")
NSDUH_2019 <-read.delim(file="data/NSDUH_2019_Tab.txt",na.strings = ".")

NSDUH_2021 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| #recency
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|#freq in last month
         MICATPY|#mental health
         AMDEYR|ASDSHOM2:ASDSSOC2| #adult depression
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME), #demographics         
         IRVAPNICREC) %>%              #vaping
  write_rds(file="data/NSDUH_2021_YA.rds")

NSDUH_2020 %>%
  filter(CATAGE==2) %>%# list of comparable variables
comparability <- read_excel("data/RDAS_Comparability.xlsx") %>%
  filter(!is.na(`2019-2020`)) %>%
  select(Variable) %>%
  deframe()

NSDUH_2021 <-read.delim(file="data/NSDUH_2021_Tab.txt",na.strings = ".")
NSDUH_2020 <-read.delim(file="data/NSDUH_2020_Tab.txt",na.strings = ".")
NSDUH_2019 <-read.delim(file="data/NSDUH_2019_Tab.txt",na.strings = ".")

NSDUH_2021 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| #recency
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|#freq in last month
         MICATPY|#mental health
         AMDEYR|ASDSHOM2:ASDSSOC2| #adult depression
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME), #demographics         
         IRVAPNICREC) %>%              #vaping
  write_rds(file="data/NSDUH_2021_YA.rds")

NSDUH_2020 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| 
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|
         MI_CAT_U|
         AMDEYR|ASDSHOM2:ASDSSOC2| 
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME)&          
           any_of(comparability),
         IRVAPNICREC) %>%
  write_rds(file="data/NSDUH_2020_YA.rds")

NSDUH_2019 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| #recency
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|#freq in last month
         MI_CAT_U|#mental health
         AMDEYR|ASDSHOM2:ASDSSOC2| #adult depression
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME)& #demographics         
           any_of(comparability)) %>%
  write_rds(file="data/NSDUH_2019_YA.rds")
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| 
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|
         MI_CAT_U|
         AMDEYR|ASDSHOM2:ASDSSOC2| 
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME)&          
           any_of(comparability),
         IRVAPNICREC) %>%
  write_rds(file="data/NSDUH_2020_YA.rds")

NSDUH_2019 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| #recency
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|#freq in last month
         MI_CAT_U|#mental health
         AMDEYR|ASDSHOM2:ASDSSOC2| #adult depression
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME)& #demographics         
           any_of(comparability)) %>%
  write_rds(file="data/NSDUH_2019_YA.rds")


```

```{r}
#| label: read rds
YA_2021 <- read_rds(file="data/NSDUH_2021_YA.rds")
YA_2020 <- read_rds(file="data/NSDUH_2020_YA.rds")
YA_2019 <- read_rds(file="data/NSDUH_2019_YA.rds")

```


## Data Changes
I decided to integrate data from 2021 to get a better idea of the effect of the COVID-19 pandemic. The original 2021 file had 58034 observations of 2988 variables and after filtering it had 13979 observations of 30 variables. Rather than getting rid of the variables I didn't want as I did before, I decided to focus on variables from the categories drug use, mental health, depression, demographics, and income. I applied this to 2020 and 2019 and got data frames with 30 and 29 variables respectively. 

The variable `IRVAPNICREC` exists only in 2020 and 2021 and it assesses recency of vaping nicotine. I decided to keep the variable since e-cigarettes and vapes are pretty popular among young adults.

I also decided to include young adults (18-25) that were not currently in college in order to have something to compare college students to. I created new rds files for young adults and deleted the previous college rds files. 

## Data Reliability
As I read more of the documentation for the 2019 and 2020 data sets I found out that the 2020 data set was collected for the first 2 quarters of the year, stopped, then continued online for the 4th quarter. This means it is not recommended to compare it to prior or following years despite them making a comparability chart for 2019-2020. Since the comparison was already unreliable I thought to add 2021 so I could potentially see an actual impact from COVID-19 since the pandemic started affecting the US in late 2020. Data collection in 2021 was also made up of a mix of in-person and online interviews.

## Altering Variables
There were different names for a variable that gave categorical mental illness indicator based on the 2012 model (`MICATPY` in 2021,`MI_CAT_U` in 2020 and 2021). I combined these into `MI_CAT_U` after using bind_rows to combine the years. I altered the character variable `FILEDATE` to the numeric variable `year` by getting rid of the month and day. I also added the variable `incollege` for easier comparisons. Before converting variables to factors I decided to assess missingness again.

 
```{r}
#| label: bind-years, create year and incollege variable
YA_2021 <- YA_2021 %>%
  rename(MI_CAT_U = MICATPY)

YA_19_21 <- bind_rows(YA_2021,YA_2020,YA_2019) %>%
  relocate(IRVAPNICREC, .after=IRSTMNMREC)

YA_19_21 <-YA_19_21 %>%
  separate_wider_regex(
    FILEDATE,
    patterns = c(
      "../../",
      year = "[0-9]+"
    )
  ) %>%
  mutate(year = as.numeric(year)-1)

YA_19_21 <-YA_19_21 %>%
  mutate(incollege = ifelse(EDUSCHGRD2==9|EDUSCHGRD2==10|EDUSCHGRD2==11,
                            "Enrolled",
                            "Not Enrolled"))

```

```{r}
#| label: assess missingness
YA_19_21 %>%
  miss_var_summary(order = TRUE) %>%
  slice_head(n=10) %>%
  kable()
YA_19_21 %>%
  group_by(year) %>%
  miss_var_summary() %>%
  filter(variable == "IRVAPNICREC") %>%
  kable()
```
The ASDS questions measure how depressive feelings impair role domains (home management, work, close relationships with others, and social life) on the Sheehan Disability Scale (SDS). These questions were only asked for people who reported depressive symptoms. The nicotine vaping variable is missing only in observations from 2019.

## Coverting Variables to Different Classes
  I created functions to convert similar variable types to factors. For any variable that had identical coding I created a function and used across() to convert those to factors.
  From this process I found that everyone in my subset skipped `CIGOFRSM`and `CIGWILYR` so I got rid of these variables.
  I initially tried using case_when() for to convert these however they didn't keep the factor order. I instead used fct_recode() after factoring the initial numeric value. If I had any problems I specified the levels when using factor().
  I wanted to keep the frequency variables , however, never having used a substance was coded as 91 while having used a substance before but not in the past month was coded as 93. I thought about coding both as NA and referring to the recency questions to determine the difference. I instead decided to code never as NA and not in the past month as 0 so I don't have to refer to another variable.
  The variable `EDUSCHGRD2` had both legitimate skips which I coded as "Not in school" and blank/no answer which I coded as NA.
  
```{r}
#| label: remove cig variables
YA_19_21 <- YA_19_21 %>%
  select(!CIGOFRSM:CIGWILYR)
```
  
  
```{r}
#| label: convert variables

factor_yesno <- function(x) {
  fct_recode(factor(x, levels = c("1","2")),
    "Yes"="1",
    "No"="2") 
}
factor_recency <- function(x) {
  fct_recode(factor(x),
    "≤ 30 days"="1",
    "> 30 days, ≤ 12 months"="2",
    "> 12 months"="3",
    "Never"="9")
}
numeric_frequency <- function(x) {
  case_when(
    x == 91 ~ NA,
    x == 93 ~ 0,
    .default = x)
}
factor_ASDS <- function(x) {
  fct_recode(factor(x),
      "None"="1",
      "Mild"="2",
      "Moderate"="3",
      "Severe"="4",
      "Very Severe"="5")
}

YA_19_21 <- YA_19_21 %>%
  mutate(
    across(c(STMRSSTDY,AMDEYR,GOVTPROG),factor_yesno),
    IRCIGRC = fct_recode(factor(IRCIGRC),
       "≤ 30 days"="1",
      "> 30 days, ≤ 12 months"="2",
      "> 12 months, ≤ 3 years"="3",
      "> 3 years"="4",
      "Never"="9"),
    across(IRALCRC:IRVAPNICREC,factor_recency),
    across(IRCIGFM:IRSTMNM30FQ,numeric_frequency),
    MI_CAT_U = fct_recode(factor(MI_CAT_U),
      "None"="0",
      "Mild"="1",
      "Moderate"="2",
      "Serious"="3"),
    across(ASDSHOM2:ASDSSOC2,factor_ASDS),
    IRSEX = fct_recode(factor(IRSEX),
      "Male"="1",
      "Female"="2"),
    IREDUHIGHST2 = fct_recode(factor(IREDUHIGHST2),
      "5th grade or less"="1",
      "6th grade"="2",
      "7th grade"="3",
      "8th grade"="4",
      "9th grade"="5",
      "10th grade"="6",
      "11th or 12th grade, no GED"="7",
      "GED"="8",
      "Some college"="9",
      "Associate's degree"="10",
      "College graduate or higher"="11"),
    CATAG7 = fct_recode(factor(CATAG7),
      "18-20"="4",
      "21-25"="5"),
    EDUSCHGRD2 = fct_recode(factor(EDUSCHGRD2),
      "5th grade or lower"="1",
      "6th grade"="2",
      "7th grade"="3",
      "8th grade"="4",
      "9th grade"="5",
      "10th grade"="6",
      "11th grade"="7",
      "12th grade"="8",
      "1st year"="9",
      "2nd or 3rd year"="10",
      "4th year or higher"="11",
      NULL="98",
      "Not in school"="99"),
    INCOME = fct_recode(factor(INCOME),
      "Less than $20,000"="1",
      "$20,000 - 49,999"="2",
      "$50,000 - 74,999"="3",
      "$75,000 or more"="4"))

```

```{r}
#| label: check factors
#| eval: false
YA_19_21 %>%
  select(where(is.factor)) %>%
  map(levels)
```
## Analysis
I wanted to first visualize the differences between the enrolled group and the unenrolled group.
```{r}
#| label: age compare enrolled group
YA_19_21 %>%
  ggplot(aes(x=incollege,fill=CATAG7)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Age Groups in Enrolled vs Not Enrolled", 
       x="Proportion",
       y="College Enrollment",
       fill="Age") +
  theme_fivethirtyeight()

YA_19_21 %>%
  ggplot(aes(x=incollege,fill=INCOME)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Income Groups in Enrolled vs Not Enrolled", 
       x="Proportion",
       y="College Enrollment",
       fill="Family Income") +
  theme_fivethirtyeight()
```
As expected the group not enrolled are slightly older. This group likely includes a good amount of college graduates. I expected the income of the not enrolled group to be generally lower however it seems that in the enrolled group the outer groups of less than \$20,000 and $75,000 or more are while the middle groups are larger in the not enrolled group. Perhaps people that aren't enrolled are able to contribute more to family income.

## Progress and Plan
I got pretty caught up in deciding which variables to keep so there is still space for more EDA.  If there is time I would like to create a small codebook for the 29 variables and tidy the names using the janitor package. For analysis I'd like to start seeing what proportion of the not enrolled group are college graduates and look at the difference of income and age with college students. My concern is that I may end up exploring the impact of income on drug use rather than college enrollment.
