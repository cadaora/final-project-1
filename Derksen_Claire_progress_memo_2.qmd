---
title: "Progress Memo 2"
subtitle: |
  | Final Project 
  | Data Science 1 with R (STAT 301-1)
author: "Claire Derksen"
date: today

format:
  html:
    toc: true
    embed-resources: true
    
execute:
  echo: false
  warning: false

from: markdown+emoji 
---
```{r}
#| label: load-pkgs
# Loading package(s)
library(tidyverse)
library(naniar)
library(janitor)
library(readxl)
library(knitr)
```
## Github Repo Link

<https://github.com/stat301-1-2023-fall/final-project-1-cadaora>

```{r}
#| label: create-YA-rds-files
#| eval: false

# list of comparable variables
comparability <- read_excel("data/RDAS_Comparability.xlsx") %>%
  filter(!is.na(`2019-2020`)) %>%
  select(Variable) %>%
  deframe()

NSDUH_2021 <-read.delim(file="data/NSDUH_2021_Tab.txt",na.strings = ".")
NSDUH_2020 <-read.delim(file="data/NSDUH_2020_Tab.txt",na.strings = ".")
NSDUH_2019 <-read.delim(file="data/NSDUH_2019_Tab.txt",na.strings = ".")

NSDUH_2021 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| #recency
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|#freq in last month
         MICATPY|#mental health
         AMDEYR|ASDSHOM2:ASDSSOC2| #adult depression
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME), #demographics         
         IRVAPNICREC) %>%              #vaping
  write_rds(file="data/NSDUH_2021_YA.rds")

NSDUH_2020 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| 
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|
         MI_CAT_U|
         AMDEYR|ASDSHOM2:ASDSSOC2| 
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME)&          
           any_of(comparability),
         IRVAPNICREC) %>%
  write_rds(file="data/NSDUH_2020_YA.rds")

NSDUH_2019 %>%
  filter(CATAGE==2) %>%
  select((FILEDATE|CIGOFRSM|CIGWILYR|STMRSSTDY|
         IRCIGRC| IRALCRC| IRMJRC| IRCOCRC| IRPNRNMREC| IRSTMNMREC| #recency
         IRCIGFM| IRALCFM| IRALCBNG30D| IRMJFM|IRCOCFM| IRPNRNM30FQ| IRSTMNM30FQ|#freq in last month
         MI_CAT_U|#mental health
         AMDEYR|ASDSHOM2:ASDSSOC2| #adult depression
         IRSEX|IREDUHIGHST2|CATAG7| EDUSCHGRD2|GOVTPROG| INCOME)& #demographics         
           any_of(comparability)) %>%
  write_rds(file="data/NSDUH_2019_YA.rds")


```

```{r}
#| label: read rds
YA_2021 <- read_rds(file="data/NSDUH_2021_YA.rds")
YA_2020 <- read_rds(file="data/NSDUH_2020_YA.rds")
YA_2019 <- read_rds(file="data/NSDUH_2019_YA.rds")

```


## Data Changes
I decided to integrate data from 2021 to get a better idea of the effect of the COVID-19 pandemic. The original 2021 file had 58034 observations of 2988 variables and after filtering it had 13979 observations of 30 variables. Rather than getting rid of the variables I didn't want as I did before, I decided to focus on variables from the categories drug use, mental health, depression, demographics, and income. I applied this to 2020 and 2019 and got data frames with 30 and 29 variables respectively. 

The variable `IRVAPNICREC` exists only in 2020 and 2021 and it assesses recency of vaping nicotine. I decided to keep the variable since e-cigarettes and vapes are pretty popular among young adults.

I also decided to include young adults (18-25) that were not currently in college in order to have something to compare college students to. I created new rds files for young adults and deleted the previous college rds files. 

## Data Reliability
As I read more of the documentation for the 2019 and 2020 data sets I found out that the 2020 data set was collected for the first 2 quarters of the year, stopped, then continued online for the 4th quarter. This means it is not recommended to compare it to prior or following years despite them making a comparability chart for 2019-2020. Since the comparison was already unreliable I thought to add 2021 so I could potentially see an actual impact from COVID-19 since the pandemic started affecting the US in late 2020. Data collection in 2021 was also made up of a mix of in-person and online interviews.

## Altering Variables
There were different names for a variable that gave categorical mental illness indicator based on the 2012 model (`MICATPY` in 2021,`MI_CAT_U` in 2020 and 2021). I combined these into `MI_CAT_U` after using bind_rows to combine the years. I altered the character variable `FILEDATE` to the numeric variable `year` by getting rid of the month and day. I also added the variable `incollege` for easier comparisons. Before converting variables to factors I decided to assess missingness again.

 
```{r}
#| label: bind-years, create year and incollege variable
YA_2021 <- YA_2021 %>%
  rename(MI_CAT_U = MICATPY)

YA_19_21 <- bind_rows(YA_2021,YA_2020,YA_2019) %>%
  relocate(IRVAPNICREC, .after=IRSTMNMREC)

YA_19_21 <-YA_19_21 %>%
  separate_wider_regex(
    FILEDATE,
    patterns = c(
      "../../",
      year = "[0-9]+"
    )
  ) %>%
  mutate(year = as.numeric(year)-1)

YA_19_21 <-YA_19_21 %>%
  mutate(incollege = ifelse(EDUSCHGRD2==9|EDUSCHGRD2==10|EDUSCHGRD2==11,
                            "Enrolled",
                            "Not Enrolled"))

```

```{r}
#| label: assess missingness
YA_19_21 %>%
  miss_var_summary(order = TRUE) %>%
  slice_head(n=10) %>%
  kable()
YA_19_21 %>%
  group_by(year) %>%
  miss_var_summary() %>%
  filter(variable == "IRVAPNICREC") %>%
  kable()
```
The ASDS questions measure how depressive feelings impair role domains (home management, work, close relationships with others, and social life) on the Sheehan Disability Scale (SDS). These questions were only asked for people who reported depressive symptoms. The nicotine vaping variable is missing only in observations from 2019.

## Coverting Variables to Different Classes
  I created functions to convert similar variable types to factors. For any variable that had identical coding I created a function and used across() to convert those to factors.
  From this process I found that everyone in my subset skipped `CIGOFRSM`and `CIGWILYR` so I got rid of these variables.
  
  I wanted to keep the frequency variables , however, never having used a substance was coded as 91 while having used a substance before but not in the past month was coded as 93. I thought about coding both as NA and referring to the recency questions to determine the difference. I instead decided to code never as NA and not in the past month as 0 so I don't have to refer to another variable.
  The variable `EDUSCHGRD2` had both legitimate skips which I coded as "Not in school" and blank/no answer which I coded as NA.
  
```{r}
#| label: remove cig variables
YA_19_21 <- YA_19_21 %>%
  select(!CIGOFRSM:CIGWILYR) %>%
```
  
  
```{r}
#| label: convert variables
factor_yesno <- function(x) {
  case_when(
    x == 1 ~ "Yes",
    x == 2 ~ "No",
    .default = NA) %>%
    factor()
}
factor_recency <- function(x) {
  case_when(
    x == 1 ~ "≤ 30 days",
    x == 2 ~ "> 30 days, ≤ 12 months",
    x == 3 ~ "> 12 months",
    x == 9 ~ "Never") %>%
    factor()
}
numeric_frequency <- function(x) {
  case_when(
    x == 91 ~ NA,
    x == 93 ~ 0,
    .default = x)
}
factor_ASDS <- function(x) {
  case_when(
      x == 1 ~ "None",
      x == 2 ~ "Mild",
      x == 3 ~ "Moderate",
      x == 4 ~ "Severe",
      x == 5 ~ "Very Severe",
      .default = NA)
}

YA_19_21 <-YA_19_21 %>%
  mutate(
    across(c(STMRSSTDY,AMDEYR,GOVTPROG),factor_yesno),
    IRCIGRC = fct_recode(factor(IRCIGRC),
       "≤ 30 days"="1",
      "> 30 days, ≤ 12 months"="2",
      "> 12 months, ≤ 3 years"="3",
      "> 3 years"="4",
      "Never"="9"),
    across(IRALCRC:IRVAPNICREC,factor_recency),
    across(IRCIGFM:IRSTMNM30FQ,numeric_frequency),
    MI_CAT_U = case_when(
      MI_CAT_U == 0 ~ "None",
      MI_CAT_U == 1 ~ "Mild",
      MI_CAT_U == 2 ~ "Moderate",
      MI_CAT_U == 3 ~ "Serious",
      .default = NA),
    across(ASDSHOM2:ASDSSOC2,factor_ASDS),
    IRSEX = case_when(
      IRSEX == 1 ~ "Male",
      IRSEX == 2 ~ "Female"),
    IREDUHIGHST2 = case_when(
      IREDUHIGHST2 == 1 ~ "5th grade or less",
      IREDUHIGHST2 == 2 ~ "6th grade",
      IREDUHIGHST2 == 3 ~ "7th grade",
      IREDUHIGHST2 == 4 ~ "8th grade",
      IREDUHIGHST2 == 5 ~ "9th grade",
      IREDUHIGHST2 == 6 ~ "10th grade",
      IREDUHIGHST2 == 7 ~ "11th or 12th grade, no GED",
      IREDUHIGHST2 == 8 ~ "GED",
      IREDUHIGHST2 == 9 ~ "Some college",
      IREDUHIGHST2 == 10 ~ "Associate's degree",
      IREDUHIGHST2 == 11 ~ "College graduate or higher"),
    CATAG7 = case_when(
      CATAG7 == 4 ~ "18-20",
      CATAG7 == 5 ~ "21-25"),
    EDUSCHGRD2 = case_when(
      EDUSCHGRD2 == 1 ~ "5th grade or lower",
      EDUSCHGRD2 == 2 ~ "6th grade",
      EDUSCHGRD2 == 3 ~ "7th grade",
      EDUSCHGRD2 == 4 ~ "8th grade",
      EDUSCHGRD2 == 5 ~ "9th grade",
      EDUSCHGRD2 == 6 ~ "10th grade",
      EDUSCHGRD2 == 7 ~ "11th grade",
      EDUSCHGRD2 == 8 ~ "12th grade",
      EDUSCHGRD2 == 9 ~ "1st year",
      EDUSCHGRD2 == 10 ~ "2nd or 3rd year",
      EDUSCHGRD2 == 11 ~ "4th year or higher",
      EDUSCHGRD2 == 99 ~ "Not in school",
      EDUSCHGRD2 == 98 ~ NA),
    INCOME = case_when(
      INCOME == 1 ~ "Less than $20,000",
      INCOME == 2 ~ "$20,000 - 49,999",
      INCOME == 3 ~ "$50,000 - 74,999",
      INCOME == 4 ~ "$75,000 or more"))

levels(YA_19_21$IRALCRC)

```


## Progress and Plan
I got pretty caught up in deciding which variables to keep so there is still space for more EDA. I was unable to factorize the variables but I have a good idea of how to continue. I'll create a function to convert the frequency variables from numerics to factors. I may create other functions for variables with similar factors but otherwise I could approach every variable at a time. If there is time I would like to create a small for the 31 variables and tidy the names using the janitor package. For analysis I'd like to start with assessing the income demographics and age spread of the in and out of college groups. This could visualize any differences. My thought is that the group not in college may be more likely to be low income and we would instead be exploring the affect of income on drug use. I may instead seperate groups into in college and post college to try and control for that.
